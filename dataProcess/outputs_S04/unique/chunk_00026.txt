大约五秒钟后,攻击者就完全控制了目标主机,并且无法被检测到。AvosLocker勒索软件巧妙地结合了各种策略来禁用端点防御。供应商从2021年12月开始添加新的模式匹配检测数据,以更好地识别类似AvosLocker的攻击。对于企业来说,更好的方法是在其端点上添加一层非基于检测的保护措施,以阻止在尚未存在检测数据时发生的类似AvosLocker的攻击。

关于AvosLocker,无论是查找文件还是行为,基于模式匹配的恶意软件检测并不总是能够识别攻击,尤其是在早期阶段。然而,像删除或加密大量文件这样的嘈杂活动是非常容易识别的。当AvosLocker执行这些嘈杂活动时,检测工具已经被禁用了。这是通过让目标Windows端点运行在“安全模式”下来实现的。许多端点保护工具在“安全模式”下不会运行。

在重启主机进入“安全模式”之前,AvosLocker会修改控制“安全模式”下端点保护工具是否可以运行的注册表键。此时没有任何东西可以检测到AvosLocker所做的操作。在触发“安全模式”之前,AvosLocker安装了AnyDesk并禁用了Windows更新。AnyDesk是一个端点管理工具。通过安装它,攻击者可以在“安全模式”下远程删除、安装、修改或运行主机上的几乎所有内容。AvosLocker禁用Windows更新可能是为了防止微软在攻击者完成操作之前向受感染主机推送特定于AvosLocker的模式匹配检测数据。勒索软件专业人员有时会在感染后几周或几个月后再返回。

我们看到的所有样本都是通过PDQ Deploy启动攻击的,这也是一个端点管理工具。所有上述情况都可能以不同的方式开始。要使用PDQ Deploy,它要么已经安装并且其管理控制被窃取,要么必须秘密安装。前者要求他们窃取该工具的管理员凭据。后者则需要已经成功进行了一次相当大的入侵。

AppGuard如何击败AvosLocker?最近观察到的AvosLocker攻击始于PDQ Deploy。如果您的组织在其端点上没有安装此工具,AppGuard的默认策略将阻止非法安装,在第一阶段击败此类攻击。如果它已被合法部署,那么攻击者必须先窃取您的管理凭据才能进行后续阶段的操作。由于PDQ Deploy是一个端点管理工具,必须允许其进行非常敏感的添加和删除操作,因此企业必须警惕保护这些凭据。

从这里开始,我们将以一种更一般的方式来看待AvosLocker,即某种方式、某条路径使shell脚本被下载并在目标端点上触发,而无需使用PDQ Deploy。如果这个脚本从用户空间或其他加载/启动受限的文件夹启动,那么AppGuard将会阻止它。如果它以某种方式从其他地方启动,那么AppGuard的操作系统实用程序禁止将中止攻击。操作系统实用程序也被网络安全人员称为“本地生存二进制文件”(LOLbins)。AppGuard强制执行策略,防止攻击者使用危险的LOLbins造成伤害。观察到的AvosLocker脚本完全依赖于LOLbins。有时,AppGuard策略必须允许某个LOLbin运行以支持合法的工作流程。在这种情况下,AppGuard会对该LOLbin施加限制性控制,以限制其允许的操作。

恶意的.bat脚本旨在执行以下操作,但被AppGuard阻止:- 修改“安全模式”注册表键,使得选择的端点保护工具在主机运行在“安全模式”时无法操作- 禁用Windows Defender功能- 禁用Windows更新- 创建新的本地管理员用户帐户- 安装AnyDesk并设置在主机运行在“安全模式”时触发- 重启主机进入“安全模式”。

结论是基于检测的工具必须识别恶意文件或行为模式。某些行为模式直到多个攻击阶段执行后才被识别。如果识别不够及时,恶意软件可以成功攻击端点保护工具。在这种情况下,AvosLocker触发“安全模式”以避开那些不在“安全模式”下运行的端点保护工具。对于一些确实在“安全模式”下运行的工具,实际上将其“安全模式”设置改为“关闭”。因此,一旦进入“安全模式”,AvosLocker就可以为所欲为,没有任何东西能检测到它。然而,如果AppGuard正在保护同一主机,AvosLocker就无法执行任何导致这种情况的操作。AppGuard无需识别任何东西即可做到这一点;它是一种基于控制的保护,强制执行零信任原则。在现有的基于检测的工具基础上添加AppGuard,可以显著提高端点抵御复杂恶意软件攻击的能力。