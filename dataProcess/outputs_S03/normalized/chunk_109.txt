众所周知,端点文件夹中的文件可能会对你造成伤害。大多数恶意文件经常被攻击者重复使用,基于检测的防御措施可以很好地处理这些文件。然而,有经验的攻击者会使用工具修改恶意文件以逃避检测。因此,企业需要补充其基于检测的防御措施,采用不需要识别恶意文件就能击败它们的工具。这篇博客旨在向高管解释他们的技术人员需要他们从高层次上理解的内容。

博客摘要
忘记全面的应用控制
为什么用户空间文件夹比系统空间文件夹风险更大
最低权限:最终用户应无提升权限运行PC
高风险应用程序使某些系统空间文件夹成为高风险
工作站与服务器的风险及缓解措施
文件夹中的恶意文件,仅检测是不够的
你需要对高风险文件夹内的恶意文件进行默认拒绝
为什么应用控制既过于复杂又不足以应对恶意文件
AppGuard是解决端点文件夹中恶意文件的更简单、更好的解决方案

忘记全面的应用控制
部署和操作应用控制是繁重的任务。尽管许多供应商指定了令人头疼的“允许列表”,但仍然如此。而且更糟糕的是,这还不够;但这又是另一个话题。重要的是要知道,应用控制旨在限制从端点上的每个文件夹启动和加载可执行文件和脚本文件。不像聪明的高管们那样对高风险和低风险事物区别对待,应用控制通常对所有文件夹一视同仁,从而产生了大量不必要的工作。

为什么用户空间文件夹比系统空间文件夹风险更大
记住,风险不仅仅是潜在影响,还包括影响的可能性。用户空间是微软为笔记本电脑和台式机创造的一个概念。它由没有提升权限的最终用户可以保存和更改文件的文件夹组成。系统空间则由操作系统(OS)不允许最终用户在没有提升权限的情况下保存和更改文件的文件夹组成。最初,操作系统和应用程序文件属于系统空间...谷歌多年前通过Chrome改变了这一点,使得Chrome可以安装到用户空间,这样最终用户可以在企业环境中使用Chrome而无需IT将其安装到系统空间。现在,用户空间通常充满了合法和恶意的应用程序。对手总是将恶意文件“丢弃”到用户空间。例如,如果最终用户用Microsoft Word打开一个武器化的文档或访问一个黑客攻击浏览器的网站,这些被劫持的应用程序可能写入磁盘的任何文件在最终用户缺乏提升权限的情况下通常无法进入系统空间。但它们总是可以写入用户空间。虽然系统空间中恶意文件的潜在影响更大,但可能性要小得多。现在,随着合法和潜在恶意的可执行文件和脚本文件都在用户空间中,企业面临着一个危险的攻击面。

最低权限:最终用户应无提升权限运行PC
让我们暂时偏离一下,讨论一个重要原因。上述用户空间和系统空间的区别应该让你更清楚地认识到,坚持要求最终用户不要以管理员身份登录工作站的重要性。这会使系统空间更容易被对手访问。告诉你的IT/Sec-Ops人员,你支持这个原因。

高风险应用程序使某些系统空间文件夹成为高风险
企业服务器更多地被应用程序而不是最终用户使用。Windows Server上存在用户空间文件夹。它们仍然代表一个攻击面,因为任何被劫持的应用程序都可以写入其中。然而,在服务器上,某些应用程序必须被允许写入系统空间的文件夹。如果这些应用程序存在较高的被攻破风险,那么这些系统空间文件夹也必须被视为高风险。你的安全控制必须减轻来自用户空间和这些高风险系统空间文件夹的文件启动和加载风险。其他文件夹也存在一些风险,但较小。

工作站与服务器的风险及缓解措施
被攻破的服务器的影响通常远大于工作站。你可能会认为在工作站上被攻破的可能性要高得多。这是真的,但那些花时间修改其恶意文件的复杂对手更喜欢针对服务器。幸运的是,由于服务器主要用来托管应用程序而不是不守规矩的最终用户,因此可以更积极地锁定服务器以减轻风险,同时不太可能干扰合法活动。

文件夹中的恶意文件,仅检测是不够的
你的检测工具试图区分好文件和坏文件。有些会上传签名或文件本身以进行云分析,以区分好坏。简而言之,这些检测方法对大多数文件是成功的,但在对手花时间使用修改过的文件以逃避检测时就显得力不从心了。对手也有云服务。与VirusTotal不同,每次文件提交都会通知检测供应商,对手的云服务不会这样做。熟练的对手在攻击前就知道他们的恶意软件被检测到的可能性。

你需要对高风险文件夹内的恶意文件进行默认拒绝
以上代表了通过漏洞利用进行的AppJacking,这些漏洞在野外被利用时还没有补丁(即零日攻击)。人们永远不知道是否有其他零日攻击正在发生。这种情况永远不会结束。

AppJacking概括了终端内的操作。

为什么这些操作对你很重要?显然,基于检测的保护远非完美。行为工具依赖于模式匹配检测数据来确定应用程序的操作是否合法或恶意。统计置信度的高低决定了所有差异。聪明的攻击者知道这一点,并通过增加额外的行为和对象以及阶段之间的延迟来降低统计置信度。最好的情况是,这意味着三级分析师需要分析和调查更多的警报,IT-Ops也需要清理混乱。最坏的情况是,检测完全被避开。然而,如果这些AppJacking操作不被允许,那么攻击就可以在不需要检测(即识别)的情况下被击败,这就是我们总结它们的原因。

AppJacking执行以下概括的操作:
- 将文件下载到磁盘:而不是让被劫持的应用程序自己执行所有需要的恶意指令,而是下载并运行其他东西来完成这些操作。
- 启动/加载磁盘上的文件。
- 修改磁盘上已有的关键系统或应用程序文件。
- 修改合法内容以获得优势。
- 确保恶意软件在主机重启时启动。
- 读取/窃取操作系统或其他应用程序内存中的数据。
- 窃取凭据和/或有价值的数据。
- 将恶意指令注入另一个应用程序的内存:通过填充大量恶意指令,将相同或另一个应用程序变成黑客工具。
- 某些应用程序(如Chrome)比其他应用程序受到更多监控,使用Chrome劫持另一个较少监控的应用程序来执行大部分恶意操作可以更加隐蔽。
- 将恶意库加载到另一个应用程序的内存中。
- 添加/修改注册表键:确保恶意软件在主机重启时启动。
- 禁用选定的安全控制。
- 启动并使用操作系统实用程序:磁盘上的恶意文件可能会被检测到,操作系统实用程序可以做恶意文件本来会做的事情。
- 启动/使用无文件进程:磁盘上的恶意文件可能会被检测到,或者无法写入磁盘,可以向这些进程中加载大量的恶意指令。
- 接收并执行来自远程对手的命令:人工控制的操作可以根据终端进行调整,远程使用Cobalt Strike等工具。
- 传输被盗数据:中国就是通过这种方式窃取了数万亿美元的知识产权。

上表并不旨在包罗万象。理想情况下,应用零信任原则可以缓解AppJacking风险。上面“AppJacking操作”表中的每一行都描述了被劫持的应用程序用于对企业造成伤害的不同方式。应用零信任意味着使用安全控制来阻止这些操作。这种方法的好处在于不必确定什么是异常或恶意的。不需要检测!结果是在端点被攻破之前,在生成检测警报之前,在三级EDR分析师必须调查之前,提供实时保护。

不幸的是,大多数EPP代理缺乏这些功能,或者它们拥有的功能过于繁琐。

端点保护代理对AppJacking的缓解

下表描述了不同通用EPP功能及其可能或不可能缓解AppJacking风险的方式。稍后,我们将看看它们在零信任原则方面能做什么和不能做什么。

EPP功能
- 补丁管理:不再被认为是标准的EPP功能;消除或屏蔽软件漏洞,使应用程序无法被利用;不能缓解其他两种AppJacking方法(即设计缺陷、代码注入)
- 反利用:将代码注入应用程序,力求防止通过漏洞利用进行的AppJacking;一旦应用程序被劫持则不起作用;没有已知的实际贡献的实证证据;一些分析师质疑其在野外是否真的有效
- 签名检测:如果在加载到目标应用程序内存之前识别出恶意文件,则可以防止AppJacking;文件操纵以逃避检测非常容易,因此这很少能防止AppJacking
- 机器学习文件检测:分析文件中的恶意指令,如果检测到恶意则防止AppJacking;使用多种混淆技术来逃避检测;一些EPP将文件上传到云端进行分析,但由于隐私和数据泄露问题,不会对潜在的武器化文档进行此类操作
- 应用程序控制:仅应用了一些零信任原则;所有实现都具有预启动功能,但很少有后启动功能;预启动阻止可执行文件、脚本和库文件的启动/加载,这些文件可以执行复杂的有害操作;后启动(也称作peri启动)限制应用程序的文件/文件夹读写操作;由于复杂性,不到0.1%的企业使用此功能
- 行为检测(也称作EDR):使用机器学习和启发式方法检测恶意行为;如果检测具有高统计置信度,则在毫秒内终止进程并将文件隔离;当检测的统计置信度较低时,会为三级分析师生成警报以进行调查和响应,而AppJacking操作则继续进行;如果警报被证实有效,有时会有自动清理,有时需要手动清理;谷歌的Project Zero在其许多零日漏洞利用分析中说,“这类漏洞利用很可能很难通用检测”,或者他们不对检测提出建议
只能应用一些零信任原则来限制被隔离应用程序在多个维度(如文件、注册表、内存、子进程、权限和网络)上的读写操作。微软的应用程序防护是唯一具备此功能的端点保护平台(EPP)产品,并免费提供给所有Windows企业许可证持有者,但使用率不到1%。企业也可以从其他供应商处购买各种实现。

将零信任原则应用于高风险应用程序意味着不允许它们执行潜在恶意操作。这些操作与企业网络安全堆栈中可能拥有的四种类型工具的关系如下所示。应用程序控制分为预执行和后执行(也称作peri执行),因为很少有应用程序控制工具支持后执行,那些支持后执行的工具被认为太难使用。尽管如此,我们可以看到每种工具对高风险应用程序可能应用的零信任缓解措施。

涵盖/遗漏的零信任原则:
- 应用程序控制(预执行)
- 应用程序控制(后执行)
- 行为检测(EDR)
- 隔离

将文件下载到磁盘:否、是、否、是
启动/加载磁盘上的文件:是、否、可能、否
修改磁盘上已有的关键系统或应用程序文件:否、是、可能、是
读取/窃取操作系统或其他应用程序内存中的数据:否、否、可能、是
将恶意指令注入另一个应用程序的内存:否、否、可能、是
将恶意库加载到另一个应用程序的内存:是、否、可能、是
添加/修改注册表键:否、是、可能、是
启动并使用操作系统实用程序:是、否、可能、是
启动/使用无文件进程:否、是、可能、是
接收并执行来自远程对手的命令:否、否、可能、是
传输被盗数据:否、否、否、是

行为检测(也称作EDR)不是零信任机制。许多“可能”答案需要解释。一个AppJacking攻击可能涉及十个阶段。如果在第三阶段发生检测,并且该检测具有高统计置信度,那么行为检测代理将在一秒钟内终止攻击中识别的所有进程。这可能发生在第四到第六阶段之前,这意味着第七到第十阶段永远不会发生。预防第七到第十阶段可能相当于上表中会被阻止的一个或多个行。但这些都是反应而非零信任拒绝。行为检测代理不会明确阻止第七到第十行的动作。相反,终止相关进程会导致这些原本会发生的行为被终止。从默认拒绝的角度来看,行为检测不是零信任机制。零信任机制本质上是确定性的:允许/拒绝特定动作。

在端点内添加零信任到网络安全防御对于缓解AppJacking风险和降低劳动力成本至关重要。优秀的医疗保健包括预防措施,如疫苗以避免感染,以及早期检测方法以治疗疾病。企业的网络安全防御也是如此,两者结合更好。检测工具可以击败可识别的恶意软件攻击。零信任工具不是通过识别恶意软件,而是通过阻止其有害行为来击败攻击。一种工具可以阻止另一种工具错过的,或者比另一种工具更早地阻止。这是优秀的网络安全防御。

通过零信任工具阻止检测工具错过的内容,并在检测工具反应之前阻止一些可检测的攻击,添加一个在端点内应用零信任的工具可以减少网络安全堆栈中多个检测工具的警报数量,从而减轻相应网络安全团队的工作负担。此外,端点内的零信任控制在实时阻止攻击,这通常发生在端点被攻破之前。这样的工具可以在检测工具在端点被攻破后做出反应时减轻那些必须修复端点的人的工作负担。

隔离看起来很好但很少部署,因为大多数实现都非常痛苦。这个话题值得单独一篇博客文章。简而言之,有几种不同的隔离工具。主机沙箱不同于网络或云沙箱,它是一个垃圾场,几年前就被企业端点移除了。微软提供的“应用程序防护”采用了进程虚拟化。这要求修改应用程序源代码,以便应用程序能够穿透边界在整个端点上工作。很少有应用程序经过这样的修改。“应用程序防护”随Windows企业许可证免费提供,但不到1%的企业选择使用它。Bromium基于驱动的隔离工具也遭受了与主机沙箱相同的命运。几乎没有EPP包含隔离功能。必须从第三方获取这些功能。

AppGuard提供了企业所需以补充检测防御的零信任能力。AppGuard结合了“隔离”和“预执行应用程序控制”,相当于上表中总结的因AppJacking导致的有害操作的所有“是”条目,详细信息见底部表格。

与其他方案相比,AppGuard的操作工作量较小。AppGuard几乎不受过去和现在的应用程序控制或隔离工具的操作困难的影响。AppGuard确实需要一些前期调优,如果受保护主机进行了重大更改,有时后期也需要调优。在策略未强制执行的短暂发现阶段,可以看到一个或少数几个合法应用程序需要进行策略调优。在策略强制执行的第一周或两周内,可能还需要一些额外的调优。根据观察,部署代理中不到1%的策略与供应商指定的默认策略不同,这种调优工作量很小且很短暂。