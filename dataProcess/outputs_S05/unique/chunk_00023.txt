现代Web应用程序非常复杂,通常从数十个不同的来源加载JavaScript库,并向同样多的来源提交数据。这导致了巨大的攻击面,黑客可以利用多种攻击类型直接针对用户浏览器。Magecart就是一个很好的例子,这是一种供应链攻击。为了应对这种情况,浏览器供应商(如Google、Microsoft、Mozilla等)已经就一项标准达成一致,该标准允许应用程序所有者从安全角度控制浏览器行为。这个标准被称为内容安全策略(CSPs)。应用程序所有者通过一个特殊格式化的HTTP响应头来实现内容安全策略,然后由浏览器解析和执行。例如,此头可用于强制仅从特定的一组URL加载JavaScript库。CSPs很好,因为它们减少了攻击面,但实施和管理起来很困难,特别是在快速发展的开发环境中。

从今天开始,我们的客户端安全产品Page Shield支持所有主要的CSP指令。我们还添加了更好的报告、自动化建议和Page Shield特定的用户角色,使CSPs更容易管理。如果您是Page Shield企业客户,请登录您的仪表板立即使用这些新功能。

假设您刚刚构建了一个Web应用程序。为了简单起见,您使用了许多服务来实现特定功能:Stripe用于结账,Zendesk用于聊天系统。这两个系统要求您在应用程序中“嵌入”JavaScript文件。完成后,这些小部件还将把数据提交回各自的端点——例如,如果有人与Zendesk聊天小部件交互,则将数据提交到Zendesk服务器。您还加载了一个自己构建的JavaScript文件,用于一些简单的交互。该文件托管在您站点自己的域下,比如example.com。您知道不应该加载其他文件,并且以安全为先的心态,您希望强制只有这些文件(而不是其他文件!)可以在用户的浏览器环境中执行。这避免了潜在的妥协,因为浏览器将拒绝执行不需要的代码。

您可以使用Page Shield策略来实现这一点,这是一个旨在简化CSPs的内容安全策略(CSPs)的抽象层。该系统允许您采用正向安全模型,让您定义允许的内容,并默认阻止其他一切。为此,我们需要遵循几个简单的步骤。首先,登录Cloudflare并转到相关区域→安全→Page Shield→策略→创建策略。我们将看到以下页面:输入策略名称(例如,“我的网站策略”),并根据需要选择使用我们的标准wirefilter语法,指定要应用策略的位置。例如,如果我们只想在结账页面上应用策略(那里数据泄露的风险更高),我们可以选择:如果传入请求匹配......URI路径包含“checkout”。在UI中,这将表示如下:

这种过滤允许您专注于最重要的部分,或者同时在特定子集的流量上测试您的策略。接下来,我们需要定义允许从何处加载脚本以及允许将数据发送到何处。有两个指令可以用于此目的:script-src(脚本)指令和connect-src(连接)指令。在撰写本文时,Stripe的脚本将从以下URL加载:https://checkout.stripe.com同一URL也用于将数据提交回Stripe系统。Zendesk类似,但为了简单起见,我们在本示例中只关注Stripe。您还从您自己的站点example.com加载了一个JavaScript文件。从“添加新指令”下拉菜单中选择“脚本”:添加后,脚本指令将显示如下:这就是魔法开始的地方。如果您的站点启用了Page Shield,您可能会注意到它可能已经检测到您的站点正在加载的JavaScript文件,并将其作为简单的复选框列表建议给您。不再需要追着开发团队成员了解您的站点正在加载什么。构建指令变得像一个简单的清单练习。构建器允许您决定是否希望允许整个域的脚本,还是仅允许特定的URL。在正常情况下,您应该期望允许所有检测到的脚本。对于Stripe,指令配置如下所示:指令预览将在构建器下方显示。