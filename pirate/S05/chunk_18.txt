只能应用一些零信任原则来限制被隔离应用程序在多个维度（如文件、注册表、内存、子进程、权限和网络）上的读写操作。微软的应用程序防护是唯一具备此功能的端点保护平台（EPP）产品，并免费提供给所有Windows企业许可证持有者，但使用率不到1%。企业也可以从其他供应商处购买各种实现。

将零信任原则应用于高风险应用程序意味着不允许它们执行潜在恶意操作。这些操作与企业网络安全堆栈中可能拥有的四种类型工具的关系如下所示。应用程序控制分为预执行和后执行（也称作peri执行），因为很少有应用程序控制工具支持后执行，那些支持后执行的工具被认为太难使用。尽管如此，我们可以看到每种工具对高风险应用程序可能应用的零信任缓解措施。

涵盖/遗漏的零信任原则：
- 应用程序控制（预执行）
- 应用程序控制（后执行）
- 行为检测（EDR）
- 隔离

将文件下载到磁盘：否、是、否、是
启动/加载磁盘上的文件：是、否、可能、否
修改磁盘上已有的关键系统或应用程序文件：否、是、可能、是
读取/窃取操作系统或其他应用程序内存中的数据：否、否、可能、是
将恶意指令注入另一个应用程序的内存：否、否、可能、是
将恶意库加载到另一个应用程序的内存：是、否、可能、是
添加/修改注册表键：否、是、可能、是
启动并使用操作系统实用程序：是、否、可能、是
启动/使用无文件进程：否、是、可能、是
接收并执行来自远程对手的命令：否、否、可能、是
传输被盗数据：否、否、否、是

行为检测（也称作EDR）不是零信任机制。许多“可能”答案需要解释。一个AppJacking攻击可能涉及十个阶段。如果在第三阶段发生检测，并且该检测具有高统计置信度，那么行为检测代理将在一秒钟内终止攻击中识别的所有进程。这可能发生在第四到第六阶段之前，这意味着第七到第十阶段永远不会发生。预防第七到第十阶段可能相当于上表中会被阻止的一个或多个行。但这些都是反应而非零信任拒绝。行为检测代理不会明确阻止第七到第十行的动作。相反，终止相关进程会导致这些原本会发生的行为被终止。从默认拒绝的角度来看，行为检测不是零信任机制。零信任机制本质上是确定性的：允许/拒绝特定动作。

在端点内添加零信任到网络安全防御对于缓解AppJacking风险和降低劳动力成本至关重要。优秀的医疗保健包括预防措施，如疫苗以避免感染，以及早期检测方法以治疗疾病。企业的网络安全防御也是如此，两者结合更好。检测工具可以击败可识别的恶意软件攻击。零信任工具不是通过识别恶意软件，而是通过阻止其有害行为来击败攻击。一种工具可以阻止另一种工具错过的，或者比另一种工具更早地阻止。这是优秀的网络安全防御。

通过零信任工具阻止检测工具错过的内容，并在检测工具反应之前阻止一些可检测的攻击，添加一个在端点内应用零信任的工具可以减少网络安全堆栈中多个检测工具的警报数量，从而减轻相应网络安全团队的工作负担。此外，端点内的零信任控制在实时阻止攻击，这通常发生在端点被攻破之前。这样的工具可以在检测工具在端点被攻破后做出反应时减轻那些必须修复端点的人的工作负担。

隔离看起来很好但很少部署，因为大多数实现都非常痛苦。这个话题值得单独一篇博客文章。简而言之，有几种不同的隔离工具。主机沙箱不同于网络或云沙箱，它是一个垃圾场，几年前就被企业端点移除了。微软提供的“应用程序防护”采用了进程虚拟化。这要求修改应用程序源代码，以便应用程序能够穿透边界在整个端点上工作。很少有应用程序经过这样的修改。“应用程序防护”随Windows企业许可证免费提供，但不到1%的企业选择使用它。Bromium基于驱动的隔离工具也遭受了与主机沙箱相同的命运。几乎没有EPP包含隔离功能。必须从第三方获取这些功能。

AppGuard提供了企业所需以补充检测防御的零信任能力。AppGuard结合了“隔离”和“预执行应用程序控制”，相当于上表中总结的因AppJacking导致的有害操作的所有“是”条目，详细信息见底部表格。

与其他方案相比，AppGuard的操作工作量较小。AppGuard几乎不受过去和现在的应用程序控制或隔离工具的操作困难的影响。AppGuard确实需要一些前期调优，如果受保护主机进行了重大更改，有时后期也需要调优。在策略未强制执行的短暂发现阶段，可以看到一个或少数几个合法应用程序需要进行策略调优。在策略强制执行的第一周或两周内，可能还需要一些额外的调优。根据观察，部署代理中不到1%的策略与供应商指定的默认策略不同，这种调优工作量很小且很短暂。
由“Unit 42”创建的Mallox勒索软件攻击树让我们将AppGuard控制应用于该攻击树的每个分支或阶段。例如，sqlserver.exe可以启动cmd.exe，但服务器上的默认策略禁止cmd.exe运行，因此整个攻击将在此停止。然而，某些终端需要运行cmd.exe。在这种情况下，修改默认策略后，AppGuard允许cmd.exe启动，但通常会“限制”cmd.exe以限制其可以执行的操作。同样地，服务器上的默认策略禁止powershell.exe运行，但对于某些需要powershell.exe的终端，AppGuard可能允许它在某些服务器上启动，但在AppGuard的“限制”下运行。出于可用性原因，AppGuard允许sqlserver.exe、cmd.exe和powershell.exe将updt.ps1文件写入高风险文件夹，但AppGuard会限制从高风险文件夹加载脚本到PowerShell，从而阻止这一部分攻击。WMIC.exe也被默认策略禁止，使得这部分攻击被阻止。
到目前为止，我们已经看了两种情况。第一种情况下，由于cmd.exe在不需要运行的服务器上被禁止，攻击被阻止。第二种情况下，cmd.exe被允许运行，但受到AppGuard的“限制”。分析还没有结束，因为我们开始考虑“如果”问题。例如，如果WMIC.exe没有被禁止，那么AppGuard将不允许由此产生的tzt.exe从其所在位置启动。即便如此，进一步使用cmd.exe和其他操作系统实用程序可能会造成伤害。其他AppGuard攻击面减少策略禁止许多操作系统实用程序运行，以扑灭此类攻击。还提到cmd.exe将脚本文件（.bat）写入Windows文件夹，而AppGuard的“限制”会阻止这种情况。此外，提到修改注册表键以绕过Raccine反勒索软件，但AppGuard不会允许cmd.exe或其他任何被“限制”的进程这样做。尽管我们已经研究了许多“如果”情景，但我们还没有探索完所有的情景。我们忽略了AppGuard的“隔离”控制。回到那个注册表键修改的例子，AppGuard的“隔离”规则可以阻止任何执行者进程进行该修改。AppGuard的“限制”保护主机免受“高风险”应用程序的影响，而“隔离”则保护主机的一部分不受其余部分的影响，以减轻未知或未预料到的执行者带来的风险，即使这些执行者没有被AppGuard“限制”。

结论
AppGuard不仅可以通过一种方式，而是通过多种不同方式击败Mallox勒索软件。这些都不需要识别每次攻击中可能变化的东西。相反，AppGuard以基于控制的终端保护软件的形式在终端内应用零信任原则，从而在不必识别恶意软件本身的情况下阻止攻击。AppGuard采用三种基本控制：“启动”、“限制”和“隔离”。“启动”禁止从高风险位置启动潜在危险的东西，也禁止启动危险但不必要的操作系统实用程序（即减少攻击面）。“限制”保护主机免受其高风险应用程序的影响。“隔离”保护主机的一部分不受其余部分的影响，特别是未知或未预料到的恶意进程。这些基本控制的组合使AppGuard能够击败AV、EDR、XDR和其他基于检测的防御无法检测或检测得太晚的恶意软件攻击。AppGuard是必不可少的保护层，不仅保护企业免受未检测到的威胁，而且还通过在警报或事件发生前消除攻击来降低基于检测的保护的运营成本。
我们主要关注三类文件：可执行文件、脚本文件和动态链接库（DLL，Windows）。Sec-Ops不希望恶意可执行文件启动，也不希望恶意脚本和DLL文件加载。IT-Ops则希望合法文件能够正常启动或加载。最好的解决方案是添加一个确定性控制来处理那些试图绕过检测的文件。这种控制利用数字签名，代表了在端点内应用的零信任原则，只允许明显可信的文件启动或加载。

为什么应用控制既过于复杂又不足以应对恶意文件？任何应用控制工具都可以限制具有有效、受信任数字签名或哈希值的文件启动和加载。以Zoom和Chrome为例，去年业界观察到这些及其他常见用户应用程序在野外出现了零日漏洞。一旦被允许启动，被利用的应用程序就会进行恶意行为。通过简单的权限提升技术，这些被劫持的应用程序随后可以向系统空间添加或更改文件。大多数应用控制工具，如微软的工具，并不控制应用程序在被允许启动后可以做什么。那些能做到这一点的工具使用起来非常困难，以至于大多数客户只使用启动控制。因此，应用控制工具必须限制整个端点的启动，而不仅仅是高风险文件夹。这意味着“允许”策略列表要比只关注高风险文件夹大100到1000倍，即更多的管理负担和中断合法工作的风险。难怪市场分析师说很少有新的应用控制部署？

AppGuard是解决端点文件夹中恶意文件的更简单、更好的解决方案。它由三个基本控制组成：启动、隔离和隔离。虽然隔离和隔离似乎与端点文件夹中的恶意文件问题无关，但它们的相关性将在稍后解释。AppGuard的启动控制仅应用于高风险文件夹，尽管管理员可以根据需要将其应用于其他文件夹。大多数高风险文件夹已经在AppGuard的默认策略中指定。AppGuard的启动控制不处理不断变化的文件哈希值。相反，AppGuard依赖于受信任发布者的数字签名，这大大简化了“允许”策略。

至于那些被劫持的用户空间应用程序，AppGuard应用了隔离控制。这可以按发布者（即包含由该发布者签名的任何应用程序）、按文件夹（包含文件夹中的任何应用程序）和/或按应用程序应用。例如，一个被隔离的Zoom正常运行，但如果它被劫持，AppGuard不允许它在系统空间中添加或更改文件。通过不让高风险应用程序更改系统空间，大大减少了对所有这些文件夹应用启动控制的必要性。只有少数标准系统空间文件夹需要启动控制，这限制了只允许由选定发布者签名的文件启动。

AppGuard的隔离不仅限于文件系统，还包括Windows注册表、进程内存、子进程、进程权限和网络通信等其他维度。隔离的目的是保护主机免受被隔离内容的影响。隔离是隔离的反面。隔离保护应用程序、文件夹和/或对象免受主机其余部分的影响。AppGuard是分层保护。如果有恶意内容以某种方式不受限制地运行，隔离规则将保护所选文件夹的内容免受主机其余部分的影响。例如，Chrome在磁盘上的文件中缓存密码。一条隔离规则确保只有Chrome可以访问它。

总之，AppGuard提供了最简单、最有效的方法来减轻企业端点文件夹中文件所带来的风险。